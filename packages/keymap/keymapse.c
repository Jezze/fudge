#include <fudge.h>
#include "keycode.h"

static struct keycode map[256] = {
    {0, {0, 0, 0, 0}},
    {1, {27, 0, 0, 0}},
    {1, {'1', 0, 0, 0}},
    {1, {'2', 0, 0, 0}},
    {1, {'3', 0, 0, 0}},
    {1, {'4', 0, 0, 0}},
    {1, {'5', 0, 0, 0}},
    {1, {'6', 0, 0, 0}},
    {1, {'7', 0, 0, 0}},
    {1, {'8', 0, 0, 0}},
    {1, {'9', 0, 0, 0}},
    {1, {'0', 0, 0, 0}},
    {1, {'+', 0, 0, 0}},
    {2, {0xC2, 0xB4, 0, 0}},
    {1, {'\b', 0, 0, 0}},
    {1, {'\t', 0, 0, 0}},
    {1, {'q', 0, 0, 0}},
    {1, {'w', 0, 0, 0}},
    {1, {'e', 0, 0, 0}},
    {1, {'r', 0, 0, 0}},
    {1, {'t', 0, 0, 0}},
    {1, {'y', 0, 0, 0}},
    {1, {'u', 0, 0, 0}},
    {1, {'i', 0, 0, 0}},
    {1, {'o', 0, 0, 0}},
    {1, {'p', 0, 0, 0}},
    {2, {0xC3, 0xA5, 0, 0}},
    {2, {0xC2, 0xA8, 0, 0}},
    {1, {'\n', 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {1, {'a', 0, 0, 0}},
    {1, {'s', 0, 0, 0}},
    {1, {'d', 0, 0, 0}},
    {1, {'f', 0, 0, 0}},
    {1, {'g', 0, 0, 0}},
    {1, {'h', 0, 0, 0}},
    {1, {'j', 0, 0, 0}},
    {1, {'k', 0, 0, 0}},
    {1, {'l', 0, 0, 0}},
    {2, {0xC3, 0xB6, 0, 0}},
    {2, {0xC3, 0xA4, 0, 0}},
    {1, {'\'', 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {1, {'<', 0, 0, 0}},
    {1, {'z', 0, 0, 0}},
    {1, {'x', 0, 0, 0}},
    {1, {'c', 0, 0, 0}},
    {1, {'v', 0, 0, 0}},
    {1, {'b', 0, 0, 0}},
    {1, {'n', 0, 0, 0}},
    {1, {'m', 0, 0, 0}},
    {1, {',', 0, 0, 0}},
    {1, {'.', 0, 0, 0}},
    {1, {'-', 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {1, {' ', 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {1, {27, 0, 0, 0}},
    {1, {'!', 0, 0, 0}},
    {1, {'\"', 0, 0, 0}},
    {1, {'#', 0, 0, 0}},
    {2, {0xC2, 0xA4, 0, 0}},
    {1, {'%', 0, 0, 0}},
    {1, {'&', 0, 0, 0}},
    {1, {'/', 0, 0, 0}},
    {1, {'(', 0, 0, 0}},
    {1, {')', 0, 0, 0}},
    {1, {'=', 0, 0, 0}},
    {1, {'?', 0, 0, 0}},
    {1, {'`', 0, 0, 0}},
    {1, {'\b', 0, 0, 0}},
    {1, {'\t', 0, 0, 0}},
    {1, {'Q', 0, 0, 0}},
    {1, {'W', 0, 0, 0}},
    {1, {'E', 0, 0, 0}},
    {1, {'R', 0, 0, 0}},
    {1, {'T', 0, 0, 0}},
    {1, {'Y', 0, 0, 0}},
    {1, {'U', 0, 0, 0}},
    {1, {'I', 0, 0, 0}},
    {1, {'O', 0, 0, 0}},
    {1, {'P', 0, 0, 0}},
    {2, {0xC3, 0x85, 0, 0}},
    {1, {'^', 0, 0, 0}},
    {1, {'\n', 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {1, {'A', 0, 0, 0}},
    {1, {'S', 0, 0, 0}},
    {1, {'D', 0, 0, 0}},
    {1, {'F', 0, 0, 0}},
    {1, {'G', 0, 0, 0}},
    {1, {'H', 0, 0, 0}},
    {1, {'J', 0, 0, 0}},
    {1, {'K', 0, 0, 0}},
    {1, {'L', 0, 0, 0}},
    {2, {0xC3, 0x96, 0, 0}},
    {2, {0xC3, 0x84, 0, 0}},
    {1, {'*', 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {1, {'>', 0, 0, 0}},
    {1, {'Z', 0, 0, 0}},
    {1, {'X', 0, 0, 0}},
    {1, {'C', 0, 0, 0}},
    {1, {'V', 0, 0, 0}},
    {1, {'B', 0, 0, 0}},
    {1, {'N', 0, 0, 0}},
    {1, {'M', 0, 0, 0}},
    {1, {';', 0, 0, 0}},
    {1, {':', 0, 0, 0}},
    {1, {'_', 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {1, {' ', 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}},
    {0, {0, 0, 0, 0}}
};

static unsigned int escaped;
static unsigned int shift;

static struct keycode *scancode2keycode(unsigned char scancode)
{

    unsigned int index;

    switch (scancode)
    {

    case 0xE0:
        escaped = 1;

        return 0;

    case 0x2A:
    case 0x36:
        shift = 1;

        return 0;

    case 0xAA:
    case 0xB6:
        shift = 0;

        return 0;

    }

    if (scancode & 0x80)
        return 0;

    index = scancode + 128 * shift;

    return &map[index];

}

void main()
{

    unsigned char buffer[FUDGE_BSIZE];
    unsigned int count, roff, woff = 0;

    call_open(CALL_O0);
    call_open(CALL_I0);

    for (roff = 0; (count = call_read(CALL_I0, roff, FUDGE_BSIZE, buffer)); roff += count)
    {

        unsigned int i;

        for (i = 0; i < count; i++)
        {

            struct keycode *keycode = scancode2keycode(buffer[i]);

            if (!keycode)
                continue;

            woff += call_write(CALL_O0, woff, keycode->length, keycode->value);

        }

    }

    call_close(CALL_I0);
    call_close(CALL_O0);

}

