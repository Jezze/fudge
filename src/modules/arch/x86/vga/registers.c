#include <fudge.h>
#include <modules/arch/x86/io/io.h>
#include "registers.h"

static unsigned char text1[0x10000];
static unsigned char text2[0x10000];
static unsigned char font1[0x10000];
static unsigned char font2[0x10000];

unsigned int inar(unsigned char index)
{

    io_outb(VGA_REG_ARINDEX, index);

    return io_inb(VGA_REG_ARREAD);

}

unsigned int incrt1(unsigned char index)
{

    io_outb(VGA_REG_CRTINDEX1, index);

    return io_inb(VGA_REG_CRTDATA1);

}

unsigned int insr(unsigned char index)
{

    io_outb(VGA_REG_SRINDEX, index);

    return io_inb(VGA_REG_SRDATA);

}

void outar(unsigned char index, unsigned char value)
{

    io_outb(VGA_REG_ARINDEX, index);
    io_outb(VGA_REG_ARWRITE, value);

}

void outcrt1(unsigned char index, unsigned char value)
{

    io_outw(VGA_REG_CRTINDEX1, (value << 8) | index);

}

void outgr(unsigned char index, unsigned char value)
{

    io_outw(VGA_REG_GRINDEX, (value << 8) | index);

}

void outsr(unsigned char index, unsigned char value)
{

    io_outw(VGA_REG_SRINDEX, (value << 8) | index);

}

void vga_save(void)
{

    io_inb(0x3DA);
    outar(0x20 | 0x10, 0x01);
    outsr(0x04, 0x06);
    outgr(0x05, 0x00);
    outgr(0x06, 0x05);
    outsr(0x02, 0x01);
    outgr(0x04, 0x00);
    buffer_copy(text1, (void *)0xA0000, 0x10000);
    outsr(0x02, 0x02);
    outgr(0x04, 0x01);
    buffer_copy(text2, (void *)0xA0000, 0x10000);
    outsr(0x02, 0x04);
    outgr(0x04, 0x02);
    buffer_copy(font1, (void *)0xA0000, 0x10000);
    outsr(0x02, 0x08);
    outgr(0x04, 0x03);
    buffer_copy(font2, (void *)0xA0000, 0x10000);

}

void vga_restore(void)
{

    io_inb(0x3DA);
    outar(0x20 | 0x10, 0x01);
    outsr(0x04, 0x06);
    outgr(0x05, 0x00);
    outgr(0x06, 0x05);
    outsr(0x02, 0x01);
    outgr(0x04, 0x00);
    buffer_copy((void *)0xA0000, text1, 0x10000);
    outsr(0x02, 0x02);
    outgr(0x04, 0x01);
    buffer_copy((void *)0xA0000, text2, 0x10000);
    outsr(0x02, 0x04);
    outgr(0x04, 0x02);
    buffer_copy((void *)0xA0000, font1, 0x10000);
    outsr(0x02, 0x08);
    outgr(0x04, 0x03);
    buffer_copy((void *)0xA0000, font2, 0x10000);

}

void vga_settext(void)
{

    io_outb(0x3C2, 0x67);
    outsr(0x00, 0x03);
    outsr(0x01, 0x00);
    outsr(0x02, 0x03);
    outsr(0x03, 0x00);
    outsr(0x04, 0x02);
    outcrt1(0x11, 0x0E);
    outcrt1(0x00, 0x5F);
    outcrt1(0x01, 0x4F);
    outcrt1(0x02, 0x50);
    outcrt1(0x03, 0x82);
    outcrt1(0x04, 0x55);
    outcrt1(0x05, 0x81);
    outcrt1(0x06, 0xBF);
    outcrt1(0x07, 0x1F);
    outcrt1(0x08, 0x00);
    outcrt1(0x09, 0x4F);
    outcrt1(0x10, 0x9C);
    outcrt1(0x11, 0x8E);
    outcrt1(0x12, 0x8F);
    outcrt1(0x13, 0x28);
    outcrt1(0x14, 0x1F);
    outcrt1(0x15, 0x96);
    outcrt1(0x16, 0xB9);
    outcrt1(0x17, 0xA3);
    outcrt1(0x18, 0xFF);
    outgr(0x00, 0x00);
    outgr(0x01, 0x00);
    outgr(0x02, 0x00);
    outgr(0x03, 0x00);
    outgr(0x04, 0x00);
    outgr(0x05, 0x10);
    outgr(0x06, 0x0E);
    outgr(0x07, 0x00);
    outgr(0x08, 0xFF);
    io_inb(0x3DA);
    outar(0x00, 0x00);
    outar(0x01, 0x01);
    outar(0x02, 0x02);
    outar(0x03, 0x03);
    outar(0x04, 0x04);
    outar(0x05, 0x05);
    outar(0x06, 0x06);
    outar(0x07, 0x07);
    outar(0x08, 0x38);
    outar(0x09, 0x39);
    outar(0x0A, 0x3A);
    outar(0x0B, 0x3B);
    outar(0x0C, 0x3C);
    outar(0x0D, 0x3D);
    outar(0x0E, 0x3E);
    outar(0x0F, 0x3F);
    outar(0x20 | 0x10, 0x0C);
    outar(0x20 | 0x11, 0x00);
    outar(0x20 | 0x12, 0x0F);
    outar(0x20 | 0x13, 0x08);
    outar(0x20 | 0x14, 0x00);

}

void vga_setgraphic(void)
{

    io_outb(0x3C2, 0x63);
    outsr(0x00, 0x03);
    outsr(0x01, 0x01);
    outsr(0x02, 0x0F);
    outsr(0x03, 0x00);
    outsr(0x04, 0x0E);
    outcrt1(0x11, 0x0E);
    outcrt1(0x00, 0x5F);
    outcrt1(0x01, 0x4F);
    outcrt1(0x02, 0x50);
    outcrt1(0x03, 0x82);
    outcrt1(0x04, 0x54);
    outcrt1(0x05, 0x80);
    outcrt1(0x06, 0xBF);
    outcrt1(0x07, 0x1F);
    outcrt1(0x08, 0x00);
    outcrt1(0x09, 0x41);
    outcrt1(0x10, 0x9C);
    outcrt1(0x11, 0x8E);
    outcrt1(0x12, 0x8F);
    outcrt1(0x13, 0x28);
    outcrt1(0x14, 0x40);
    outcrt1(0x15, 0x96);
    outcrt1(0x16, 0xB9);
    outcrt1(0x17, 0xA3);
    outcrt1(0x18, 0xFF);
    outgr(0x00, 0x00);
    outgr(0x01, 0x00);
    outgr(0x02, 0x00);
    outgr(0x03, 0x00);
    outgr(0x04, 0x00);
    outgr(0x05, 0x40);
    outgr(0x06, 0x05);
    outgr(0x07, 0x0F);
    outgr(0x08, 0xFF);
    io_inb(0x3DA);
    outar(0x00, 0x00);
    outar(0x01, 0x01);
    outar(0x02, 0x02);
    outar(0x03, 0x03);
    outar(0x04, 0x04);
    outar(0x05, 0x05);
    outar(0x06, 0x06);
    outar(0x07, 0x07);
    outar(0x08, 0x08);
    outar(0x09, 0x09);
    outar(0x0A, 0x0A);
    outar(0x0B, 0x0B);
    outar(0x0C, 0x0C);
    outar(0x0D, 0x0D);
    outar(0x0E, 0x0E);
    outar(0x0F, 0x0F);
    outar(0x20 | 0x10, 0x41);
    outar(0x20 | 0x11, 0x00);
    outar(0x20 | 0x12, 0x0F);
    outar(0x20 | 0x13, 0x00);
    outar(0x20 | 0x14, 0x00);

}

#define V_DBLSCAN 0x20
#define V_CLKDIV2 0x00
#define BIT_PLANE 3
#define PHSYNC                          0x0001
#define NHSYNC                          0x0002
#define PVSYNC                          0x0004
#define NVSYNC                          0x0008

void vga_setmode(unsigned int flags, unsigned int vdisplay, unsigned int vscan, unsigned int clockindex, unsigned int depth, unsigned int htotal, unsigned int hdisplay, unsigned int hsyncstart, unsigned int hsyncend, unsigned int hskew, unsigned int vtotal, unsigned int vsyncstart, unsigned int vsyncend, unsigned int vblankstart, unsigned int vblankend, unsigned int linewidth)
{

    unsigned int i;
    unsigned char misc;

    if ((flags & (PHSYNC | NHSYNC)) && (flags & (PVSYNC | NVSYNC)))
    {

        misc = 0x23;

        if (flags & NHSYNC)
            misc |= 0x40;

        if (flags & NVSYNC)
            misc |= 0x80;

    }

    else
    {

        unsigned int v = vdisplay;

        if (flags & V_DBLSCAN)
            v *= 2;

        if (vscan > 1)
            v *= vscan;

        if (v < 400)
            misc = 0xA3;
        else if (v < 480)
            misc = 0x63;
        else if (v < 768)
            misc = 0xE3;
        else
            misc = 0x23;

    }

    misc |= (clockindex & 0x03) << 2;

    io_outb(0x3C2, misc);

    if (depth == 4)
        outsr(0x00, 0x02);
    else
        outsr(0x00, 0x00);

    if (flags & V_CLKDIV2)
        outsr(0x01, 0x09);
    else
        outsr(0x01, 0x01);

    if (depth == 1)
        outsr(0x02, 1 << BIT_PLANE);
    else
        outsr(0x02, 0x0F);

    outsr(0x03, 0x00);

    if (depth < 8)
        outsr(0x04, 0x06);
    else
        outsr(0x04, 0x0E);

    outcrt1(0x00, (htotal >> 3) - 5);
    outcrt1(0x01, (hdisplay >> 3) - 1);
    outcrt1(0x02, (hsyncstart >> 3) - 1);
    outcrt1(0x03, ((hsyncend >> 3) & 0x1F) | 0x80);

    i = (((hskew << 2) + 0x10) & ~0x1F);

    if (i < 0x80)
        outcrt1(0x03, incrt1(0x03) | i);

    outcrt1(0x04, hsyncstart >> 3);
    outcrt1(0x05, ((((hsyncend >> 3) - 1) & 0x20) << 2) | ((hsyncend >> 3) & 0x1F));
    outcrt1(0x06, (vtotal - 2) & 0xFF);
    outcrt1(0x07, (((vtotal - 2) & 0x100) >> 8) | (((vdisplay - 1) & 0x100) >> 7) | ((vsyncstart & 0x100) >> 6) | (((vblankstart - 1) & 0x100) >> 5) | 0x10 | (((vtotal - 2) & 0x200) >> 4) | (((vdisplay - 1) & 0x200) >> 3) | ((vsyncstart & 0x200) >> 2));
    outcrt1(0x08, 0x00);
    outcrt1(0x09, (((vblankstart - 1) & 0x200) >> 4) | 0x40);

    if (flags & V_DBLSCAN)
        outcrt1(0x09, incrt1(0x09) | 0x80);

    if (vscan >= 32)
        outcrt1(0x09, incrt1(0x09) | (vscan - 1));

    outcrt1(0x10, vsyncstart & 0xFF);
    outcrt1(0x11, (vsyncend & 0x0F) | 0x20);
    outcrt1(0x12, (vdisplay - 1) & 0xFF);
    outcrt1(0x13, linewidth >> 4);
    outcrt1(0x14, 0x00);
    outcrt1(0x15, (vblankstart - 1) & 0xFF);
    outcrt1(0x16, (vblankend - 1) & 0xFF);

    if (depth < 8)
        outcrt1(0x17, 0xE3);
    else
        outcrt1(0x17, 0xC3);

    outcrt1(0x18, 0xFF);
    outgr(0x00, 0x00);
    outgr(0x01, 0x00);
    outgr(0x02, 0x00);
    outgr(0x03, 0x00);

    if (depth == 1)
    {

        outgr(0x04, BIT_PLANE);
        outgr(0x05, 0x00);

    }

    else
    {

        outgr(0x04, 0x00);

        if (depth == 4)
            outgr(0x05, 0x02);
        else
            outgr(0x05, 0x40);

    }

    outgr(0x06, 0x05);
    outgr(0x07, 0x0F);
    outgr(0x08, 0xFF);

    if (depth == 1)
    {

    }

    else
    {

        outar(0x00, 0x00);
        outar(0x01, 0x01);
        outar(0x02, 0x02);
        outar(0x03, 0x03);
        outar(0x04, 0x04);
        outar(0x05, 0x05);
        outar(0x06, 0x06);
        outar(0x07, 0x07);
        outar(0x08, 0x08);
        outar(0x09, 0x09);
        outar(0x0A, 0x0A);
        outar(0x0B, 0x0B);
        outar(0x0C, 0x0C);
        outar(0x0D, 0x0D);
        outar(0x0E, 0x0E);
        outar(0x0F, 0x0F);

        if (depth == 4)
            outar(0x10, 0x81);
        else
            outar(0x10, 0x41);

    }

    /* 0x11 */
    outar(0x12, 0x0F);
    outar(0x13, 0x00);
    outar(0x14, 0x00);

}

